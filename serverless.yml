service: canpoli-api

provider:
  name: aws
  runtime: python3.12
  region: ca-central-1
  memorySize: 512
  timeout: 30
  environment:
    # Database URL from Secrets Manager
    DATABASE_URL: "{{resolve:secretsmanager:canpoli/database-url:SecretString:DATABASE_URL}}"
    LOG_LEVEL: INFO
    ENVIRONMENT: "production"
    CORS_ORIGINS: '[]'  # Update with your domain: '["https://yourdomain.com"]'
    REDIS_URL: "{{resolve:ssm:/canpoli/redis-url}}"
    FREE_RATE_LIMIT_PER_MINUTE: 50
    PAID_RATE_LIMIT_PER_MINUTE: 500
    API_KEY_HMAC_SECRET: "{{resolve:ssm:/canpoli/api-key-hmac-secret}}"
    STRIPE_SECRET_KEY: "{{resolve:secretsmanager:canpoli/stripe:SecretString:STRIPE_SECRET_KEY}}"
    STRIPE_WEBHOOK_SECRET: "{{resolve:secretsmanager:canpoli/stripe:SecretString:STRIPE_WEBHOOK_SECRET}}"
    STRIPE_PRICE_ID: "{{resolve:ssm:/canpoli/stripe-price-id}}"
    STRIPE_CHECKOUT_SUCCESS_URL: "https://canpoli.dev/billing/success?session_id={CHECKOUT_SESSION_ID}"
    STRIPE_CHECKOUT_CANCEL_URL: "https://canpoli.dev"
    STRIPE_PORTAL_RETURN_URL: "https://canpoli.dev/account"
    CLERK_JWKS_URL: "{{resolve:ssm:/canpoli/clerk-jwks-url}}"
    CLERK_ISSUER: "{{resolve:ssm:/canpoli/clerk-issuer}}"
    CLERK_AUDIENCE: "{{resolve:ssm:/canpoli/clerk-audience}}"
    SENTRY_DSN: "{{resolve:secretsmanager:canpoli/sentry:SecretString:SENTRY_DSN}}"
    SENTRY_ENVIRONMENT: "production"
    SENTRY_SEND_DEFAULT_PII: "false"
  # VPC configuration for RDS access (create these resources in AWS Console first)
  # Uncomment after creating VPC resources and storing IDs in SSM
  vpc:
    securityGroupIds:
      - sg-065816c7e494251a9
    subnetIds:
      - subnet-0e95cda927d31c4b2
      - subnet-0e995cc918a9cff68
      - subnet-0a625f93d8bc86357

functions:
  api:
    handler: canpoli.lambda_handler.handler
    events:
      # Catch-all route for FastAPI
      - httpApi:
          method: '*'
          path: '/{proxy+}'
      # Root path
      - httpApi:
          method: GET
          path: /
  ingest:
    handler: canpoli.lambda_ingest.handler
    timeout: 300
    events:
      - schedule: rate(1 day)

plugins:
  - serverless-python-requirements

custom:
  pythonRequirements:
    # Use Docker to build dependencies for Lambda Linux environment
    dockerizePip: true
    # Reduce package size
    slim: true
    # Keep binary files intact (needed for asyncpg)
    strip: false
    # Use Poetry for dependency resolution
    usePoetry: true
    # Exclude dev dependencies
    poetryWithoutDev: true

package:
  patterns:
    # Include application code
    - 'canpoli/**'
    # Exclude unnecessary files
    - '!tests/**'
    - '!alembic/**'
    - '!.git/**'
    - '!.pytest_cache/**'
    - '!.mypy_cache/**'
    - '!.ruff_cache/**'
    - '!*.md'
    - '!Dockerfile'
    - '!docker-compose*.yml'
    - '!.env*'

resources:
  Resources:
    AlarmTopic:
      Type: AWS::SNS::Topic
      Properties:
        TopicName: canpoli-alarms
    ApiErrorsAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: canpoli-api-errors
        Namespace: AWS/Lambda
        MetricName: Errors
        Dimensions:
          - Name: FunctionName
            Value:
              Ref: ApiLambdaFunction
        Statistic: Sum
        Period: 300
        EvaluationPeriods: 1
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - Ref: AlarmTopic
    IngestErrorsAlarm:
      Type: AWS::CloudWatch::Alarm
      Properties:
        AlarmName: canpoli-ingest-errors
        Namespace: AWS/Lambda
        MetricName: Errors
        Dimensions:
          - Name: FunctionName
            Value:
              Ref: IngestLambdaFunction
        Statistic: Sum
        Period: 900
        EvaluationPeriods: 1
        Threshold: 1
        ComparisonOperator: GreaterThanOrEqualToThreshold
        TreatMissingData: notBreaching
        AlarmActions:
          - Ref: AlarmTopic
